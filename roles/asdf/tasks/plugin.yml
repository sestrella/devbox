---
- name: "{{ plugin.name }} - Install dependencies"
  apt:
    name: "{{ asdf_dependencies[plugin.name] }}"
    state: present
  become: true
  when: asdf_dependencies[plugin.name] is defined

- name: "{{ plugin.name }} - Install plugin"
  command: "{{ asdf_dir }}/bin/asdf plugin-add {{ plugin.name }} {{ plugin_repo }}"
  args:
    creates: "{{ asdf_dir }}/plugins/{{ plugin.name }}"
  vars:
    plugin_repo: "{{ plugin.repo | default }}"

- name: "{{ plugin.name }} - Install keyring"
  command: "bash {{ asdf_dir }}/plugins/nodejs/bin/import-release-team-keyring"
  when: plugin.name == "nodejs"

- name: "{{ plugin.name }} - Default packages"
  template:
    src: default-packages.j2
    dest: "{{ ansible_user_dir }}/.default-gems"
  when:
    - plugin.name == "ruby"
    - plugin.default_packages is defined

- name: "{{ plugin.name }} - Default packages"
  template:
    src: default-packages.j2
    dest: "{{ ansible_user_dir }}/.default-python-packages"
  when:
    - plugin.name == "python"
    - plugin.default_packages is defined

- name: "{{ plugin.name }} - Install versions"
  command: "{{ asdf_dir }}/bin/asdf install {{ plugin.name }} {{ item }}"
  args:
    creates: "{{ asdf_dir }}/installs/{{ plugin.name }}/{{ item }}"
  with_items: "{{ plugin.versions }}"
  when: plugin.versions is defined

- name: "{{ plugin.name }} - Set global version"
  lineinfile:
    path: ~/.tool-versions
    line: "{{ plugin.name }} {{ plugin.global }}"
    create: true
  when: plugin.global is defined
